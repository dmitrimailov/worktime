#:kivy 2.1.0

# Мы говорим Kivy, что корневым виджетом будет ScreenManager.
# Он будет управлять переключением между нашими экранами.
# Мы также сразу регистрируем все экраны, которые определили в main.py,
# и даем каждому уникальное имя (name), по которому будем к ним обращаться.
ScreenManager:
    MainScreen:
        name: 'main'
    HistoryScreen:
        name: 'history'
    AddEditScreen:
        name: 'add_edit'
    SettingsScreen:
        name: 'settings'


# Теперь описываем внешний вид каждого экрана.
# <ИмяКласса>: - это правило для виджета с таким классом.

<MainScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: "24dp"
        spacing: "24dp"
        adaptive_height: True
        pos_hint: {"center_x": .5, "center_y": .5}

        MDLabel:
            text: 'Учет рабочего времени'
            halign: "center"
            font_style: "Headline"
            role: "small"
            adaptive_height: True

        # В KivyMD 2.0+ текст кнопки задается через вложенный виджет MDButtonText
        MDButton:
            style: "filled"
            on_press: app.root.current = 'add_edit'
            size_hint_x: .7
            pos_hint: {"center_x": .5}
            MDButtonText:
                text: 'Добавить запись'

        MDButton:
            style: "filled"
            on_press: root.show_month_picker_dialog()
            size_hint_x: .7
            pos_hint: {"center_x": .5}
            MDButtonText:
                text: 'Просмотр истории'

        MDButton:
            style: "outlined"
            on_press: app.root.current = 'settings'
            size_hint_x: .7
            pos_hint: {"center_x": .5}
            MDButtonText:
                text: 'Настройки'

        MDButton:
            style: "text"
            on_press: app.stop()
            size_hint_x: .7
            pos_hint: {"center_x": .5}
            MDButtonText:
                text: 'Выход'

# Виджет для диалога выбора месяца/года
<MonthYearPicker>:
    year_input: year_id
    month_input: month_id
    orientation: 'vertical'
    spacing: "20dp"  # Немного увеличим отступ для M3
    size_hint_y: None
    height: "160dp"  # Увеличим высоту, так как поля M3 стали выше

    MDTextField:
        id: year_id
        mode: "outlined"  # Стиль поля (outlined или filled)
        input_filter: "int"
        
        MDTextFieldHintText:
            text: "Год"
            
        # Для ограничения длины в M3 часто используют MDTextFieldHelperText
        MDTextFieldHelperText:
            text: "Макс. 4 цифры"
            mode: "on_focus"

    MDTextField:
        id: month_id
        mode: "outlined"
        input_filter: "int"
        
        MDTextFieldHintText:
            text: "Месяц (1-12)"


<HistoryScreen>:
    daily_entries_list: daily_entries_list_id

    MDBoxLayout:
        orientation: 'vertical'
        
        ScrollView:
            MDBoxLayout:
                orientation: 'vertical'
                adaptive_height: True
                padding: '10dp'
                spacing: '10dp'

                MDLabel:
                    id: period_label
                    text: "Сводка за ММ.ГГГГ"
                    halign: 'center'
                    font_style: 'Title'
                    role: 'large'
                    adaptive_height: True

                MDDivider:

                MDLabel:
                    text: "Детализация по дням:"
                    halign: 'left'
                    font_style: 'Title'
                    role: 'small'
                    adaptive_height: True

                MDList:
                    id: daily_entries_list_id
                    adaptive_height: True

                MDDivider:

                MDLabel:
                    text: "Итоги за месяц:"
                    halign: 'left'
                    font_style: 'Title'
                    role: 'small'
                    adaptive_height: True

                MDListItem:
                    MDListItemHeadlineText:
                        text: "Количество рабочих дней"
                    MDListItemSupportingText:
                        id: work_days_value
                        text: "0"

                MDListItem:
                    MDListItemHeadlineText:
                        text: "Отработано часов (к оплате)"
                    MDListItemSupportingText:
                        id: total_hours_value
                        text: "0 ч."

                MDDivider:

                MDListItem:
                    MDListItemHeadlineText:
                        text: "Начислено (грязными)"
                    MDListItemSupportingText:
                        id: gross_pay_value
                        text: "0.00 руб."

                MDListItem:
                    MDListItemHeadlineText:
                        text: "НДФЛ"
                    MDListItemSupportingText:
                        id: tax_value
                        text: "0.00 руб."

                MDListItem:
                    MDListItemHeadlineText:
                        text: "К выплате (чистыми)"
                    MDListItemSupportingText:
                        id: net_pay_value
                        text: "0.00 руб."

                MDListItem:
                    MDListItemHeadlineText:
                        text: "Выплаченный аванс"
                    MDListItemSupportingText:
                        id: advance_value
                        text: "0.00 руб."

                MDDivider:

                MDListItem:
                    MDListItemHeadlineText:
                        text: "Итого к получению"
                    MDListItemSupportingText:
                        id: final_payout_value
                        text: "[b]0.00 руб.[/b]"
                        font_style: 'Title'
                        role: 'medium'

        MDButton: # Обновлен синтаксис кнопки
            style: "filled"
            size_hint_y: None
            height: '48dp'
            on_press: app.root.current = 'main'
            MDButtonText:
                text: 'Назад'


<AddEditScreen>:
    # Связываем свойства из Python-класса с id виджетов
    date_button: date_button_id
    start_time_input: start_time_id
    end_time_input: end_time_id

    AnchorLayout:
        anchor_x: 'center'
        anchor_y: 'center'

        MDBoxLayout:
            orientation: 'vertical'
            size_hint_y: None
            height: self.minimum_height
            width: root.width * 0.9
            spacing: '10dp'

            MDLabel:
                text: 'Новая запись'
                font_style: 'Title'
                role: 'large'
                halign: "center"
                adaptive_height: True

            # --- Блок выбора даты ---
            MDButton: # Обновлен синтаксис кнопки
                style: "outlined"
                id: date_button_id
                size_hint_y: None
                height: '48dp'
                on_press: root.show_calendar()
                MDButtonText:
                    text: 'Выберите дату' # Этот текст обновится из Python

            # --- Блок ввода времени ---
            GridLayout:
                cols: 2
                spacing: '10dp'
                size_hint_y: None
                height: '96dp'

                MDLabel:
                    text: 'Начало (ЧЧ:ММ):'
                MDTextField:
                    id: start_time_id
                    multiline: False
                MDLabel:
                    text: 'Конец (ЧЧ:ММ):'
                MDTextField:
                    id: end_time_id
                    multiline: False

            # --- Блок кнопок ---
            MDBoxLayout:
                size_hint_y: None
                height: '48dp'
                spacing: "10dp"
                MDButton: # Обновлен синтаксис кнопки
                    style: "elevated"
                    on_press: root.save_entry()
                    MDButtonText:
                        text: 'Сохранить'
                MDButton: # Обновлен синтаксис кнопки
                    style: "text"
                    on_press: root.manager.current = 'main'
                    MDButtonText:
                        text: 'Отмена'

<SettingsScreen>:
    # Даем экрану имя, чтобы ссылаться на него в ScreenManager
    name: 'settings'

    # Привязываем python-переменные к виджетам
    lunch_input: lunch_input_id
    rate_input: rate_input_id
    advance_input: advance_input_id

    MDBoxLayout:
        orientation: 'vertical'
        padding: "10dp"
        spacing: "10dp"

        MDLabel:
            text: "Настройки расчета"
            halign: 'center'
            font_style: 'Title'
            role: 'large'
            size_hint_y: None
            height: self.texture_size[1]

        # Используем GridLayout для красивого расположения полей и их названий
        GridLayout:
            cols: 2
            spacing: "10dp"
            size_hint_y: 0.6

            MDLabel:
                text: "Обед (часы):"
                halign: "right"
            MDTextField:
                id: lunch_input_id
                hint_text: "Например, 1 или 0.5"
                input_filter: "float"

            MDLabel:
                text: "Ставка (в час):"
                halign: "right"
            MDTextField:
                id: rate_input_id
                hint_text: "Например, 495.50"
                input_filter: "float"

            MDLabel:
                text: "Аванс:"
                halign: "right"
            MDTextField:
                id: advance_input_id
                hint_text: "Например, 5000"
                input_filter: "float"

        # Пустое пространство для выравнивания
        Widget:
            size_hint_y: 0.4

        # Кнопки управления
        MDBoxLayout:
            size_hint_y: None
            height: "48dp"
            spacing: "10dp"

            MDButton: # Обновлен синтаксис кнопки
                style: "elevated"
                on_press: root.save_settings()
                MDButtonText:
                    text: "Сохранить"

            MDButton: # Обновлен синтаксис кнопки
                style: "text"
                on_press: root.manager.current = 'main'
                MDButtonText:
                    text: "Отмена"
